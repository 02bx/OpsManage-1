{% extends 'index.html' %}
{% block page-content %}
<div id="page-wrapper">

    <div class="row">
         <div class="col-lg-12">
              <h1 class="page-header"><i class="fa fa-desktop"></i>&nbsp;<code>WebSSH</code></h1>
         </div>
                <!-- /.col-lg-12 -->
    </div>


	<div class="row">
		<div class="col-lg-2">

                    <div class="chat-panel panel panel-info">
                        <div class="panel-heading">
                            <i class="fa fa-laptop fa-fw"></i> 主机列表
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
							<table id="myWebsshTable" class="table table-hover">
				            	<tr>
						            <td ><strong><i class="fa fa-terminal fa-fw"></i> {{server.ip}}</strong>
						            </td>
						            <td>
						            <a onclick="addTab('{{server.ip}}','{{gateone_api_url}}/websshFrame/{{server.id}}/?location={{server.ip}}')">
						            <span class="pull-right text-muted small"><button type="button" class="btn btn-outline btn-danger btn-xs">当前
						            </button></span>
						            </a>
					            </tr>							  
				            	{% for ds in serverList  %}
				            	<tr>
				            		{% if server.id != ds.id %}
						                <td ><strong><i class="fa fa-terminal fa-fw"></i> {{ ds.ip }}</strong>
						                </td>
						                <td>
						                	<a onclick="addTab('{{ds.ip}}','{{gateone_api_url}}/websshFrame/{{ds.id}}/?location={{ds.ip}}')">
						                	<span class="pull-right text-muted small"><button type="button" class="btn btn-outline btn-success btn-xs">连接
						                	</button></span>
						                	</a>
					                {% endif %}
					            </tr>
				                {% endfor %}							    
							  
							</table>				            
                        </div>
                        <div class="panel-footer">
                            <div class="input-group">
                                <input id="websshInput" type="text" class="form-control input-sm" onkeyup="SearchWebsshServer()" placeholder="输入主机ip..." />
                                <span class="input-group-btn">
                                    <button class="btn btn-success btn-sm">
                                        	查询
                                    </button>
                                </span>
                            </div>
                        </div>                        
                    </div>
			
				
		</div>
		<div class="col-lg-10">
			<div id="webssh_tt" class="easyui-tabs" style="width: 100%;height:750px;">
			
				<div title="{{ server.ip }}" id="gateone_container" style="position: relative; width: 100%; height: 55em;margin: 0 auto">  
				  
				    <div id="gateone"></div>  
				  
				</div>  
			</div>
		</div>
	</div>
</div>



<script type="text/javascript" src="/static/js/gateone.js"></script>  

{% if errorInfo %}
	<script type="text/javascript"> 
		window.wxc.xcConfirm("{{errorInfo}}", window.wxc.xcConfirm.typeEnum.error);
	</script> 
{% else %}
	<script type="text/javascript">
	
	function SearchWebsshServer() {
		  // 声明变量
		  var input, filter, table, tr, td, i;
		  input = document.getElementById("websshInput");
		  filter = input.value.toUpperCase();
		  table = document.getElementById("myWebsshTable");
		  tr = table.getElementsByTagName("tr");

		  // 循环表格每一行，查找匹配项
		  for (i = 0; i < tr.length; i++) {
		    td = tr[i].getElementsByTagName("td")[0];
		    if (td) {
		      if (td.innerHTML.toUpperCase().indexOf(filter) > -1) {
		        tr[i].style.display = "";
		      } else {
		        tr[i].style.display = "none";
		      }
		    } 
		  }
		}	
	
    $(document).ready(function(){           
        var ip = "{{ server.ip }}";  
        var ssh_url = 'ssh://{{ server.username }}@' + ip + ':' + {{ server.port }};             
        var request = $.ajax({  
            url:'/api/webssh/',   
            type:"GET",  
            dataType:"json",  
  
        });  
        
        request.done(function (auth_info) {
        	console.log(auth_info["auth"]);
            GateOne.init({
                auth: auth_info["auth"],
                url: auth_info["url"],
                scrollback: 10000,
                disableTermTransitions: 'true',
                autoConnectURL: ssh_url,
                showToolbar: false
            });
        }); 
//         GateOne.Net.autoConnect();
        GateOne.Base.superSandbox("GateOne.SomePlugin", ["GateOne", "GateOne.Net",  "GateOne.Terminal.Input", "GateOne.Terminal"], function(window, undefined) {   
            var location =  ip;                
            GateOne.prefs.autoConnectURL=ssh_url;  
            GateOne.prefs.fontSize="100%";  
            GateOne.prefs.scrollback = 10000;  // scrollback buffer up to 10,000 lines  
            GateOne.Terminal.loadFont("Source Code Pro", "100%");  
            GateOne.locations; // Holds the state of all current known/open locations  
            GateOne.Net.setLocation(location); // Change locations in the current tab on-the-fly!这里设置的作用在于记录和保持ssh登陆的状态，只要不logout或者断开session，关闭页面后打开还会回到上次的状态  
        });  
    }); // end of document ready  
  
  
  

  
</script> 

	<link rel="stylesheet" type="text/css" href="/static/dist/css/easyui.css">
	<link rel="stylesheet" type="text/css" href="/static/dist/css/icon.css">
<!-- 	<script type="text/javascript" src="/static/js/jquery-1.4.4.min.js"></script> -->
	<script type="text/javascript" src="/static/js/jquery.easyui.min.js"></script>
	<script>
		function addTab(title, url){
			if ($('#webssh_tt').tabs('exists', title)){
				$('#webssh_tt').tabs('select', title);
			} else {
				var content = '<iframe  scrolling="auto"  frameborder="no" border="0" marginwidth="0" marginheight="0" src="'+url+'" style="width:100%;height:100%;"></iframe>';
				$('#webssh_tt').tabs('add',{
					title:title,
					content:content,
					closable:true
				});
			}
		}
	</script>  

{% endif %}

{% endblock %}